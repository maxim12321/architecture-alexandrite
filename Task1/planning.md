# Планирование: анализ, идентификация проблем и поиск решений

## Описание основных проблем

### Пользователи интернет-магазина не получают заказы

> Клиенты жалуются менеджерам по продажам, что они не получили заказ и над их 
  изделием работают уже несколько месяцев, хотя обещали закончить за три недели.

Причин тому может быть много:
* неправильно оцениваются сроки изготовления изделий
* заказ не доходит до операторов (вовремя или совсем не доходит...)
* невозможно отслеживать изменение статуса заказов (как в интерфейсе пользователя, так и для администраторов)
* отказ сервисов
* задержки в асинхронной обработке

Причем важный факт такой:

> Проблемы не на стороне производства: производственные мощности позволяют
  справиться с заказами и могут обеспечить двукратный рост.

Возможно, это подтверждает, что неэффективно выстроено взаимодействие с операторами на производстве.

### B2B клиенты не получают заказы

B2B пользователи взаимодействуют через `MES API`, тут тоже проблемы могут быть разного характера:
* API не выдерживает нагрузки, не сохраняет заказы в БД
* неверно обновляются статусы заказов (или эти статусы невозможно отслеживать)
* нет прозрачности в процессе производства для клиентов API

### Интерфейс для операторов "тормозит"

Операторы взаимодействуют с системой через сервис, который в том числе предоставляет наружу `MES API`. Можно выделить тут такие проблемы:
* из-за повышения нагрузки на API страдает еще и исполнение существующих заказов
* одного инстанса `MES db` может не хватать на текущую нагрузку приложения
* при недоступности единственного инстанса API или БД операторы не могут брать заказы в работу

### Отказоустойчивость

> Каждое приложение имеет по одному инстансу. Базы данных имеют один инстанс,
  который работает на запись и на чтение.

Отсутствие репликации может приводить к недоступности всей системы при падении одного сервиса.
Более того, из-за отсутствия "наблюдаемости" (дашбордов, алертов и тд) никто из
команды разработки может и не узнать о недоступности сервисов, что приведет к
долгому простою системы.

### Задержки релизов

> Раньше задержки не превышали одного месяца, но в последнее время требуется всё
  больше и больше времени.

В команде всего один QA-инженер, который вручную прогоняет все E2E-сценарии перед
каждым релизом. И снова можно выделить сразу 2 проблемы:
* отсутствие автоматических тестов (кроме юнит-тестов)
* нехватка ресурсов для тестирования приложения (всего один QA-инженер)

### Возможная несогласованность статуса заказов

Статусом заказа управляет сразу несколько систем: `MES` И `Shop API` и, скорее всего `CRM`.
При этом, судя по схеме, статус заказа хранится и в `Shop DB`, и в `MES DB`,
что может приводить к несогласованности, т.к. статусы синхронизируются через
очередь событий.

Несогласованность заказов в разных системах при отсутствии мониторингов может
приводить к неожиданному поведению системы, которое ещё и тяжело воспроизводить.

## Инициативы для их устранения

### Пользователи интернет-магазина не получают заказы

Для начала нужно выявить проблемы, для этого хорошо поможет логирование, трейсинг и различные мониторинги/алерты:
* мониторинг состояния заказов
* мониторинг очереди сообщений (кол-во сообщений, read lag и тд)
* мониторинг состояния сервисов (health-check, алерты на отказ сервисов)

А далее, в зависимости от конкретной проблемы, могут помочь следующие действия:
* доработка `CRM`, если проблемы с состоянием заказов возникают из-за некорректных действий продавцов
* масштабирование проблемных сервисов для повышения их отказоустойчивости (потребует нечто вроде `API Gateway` для рутинга)
* добавление отдельной роли "тех. поддержки" в проект, которые будут разбираться с обращениями клиентов

### B2B клиенты не получают заказы

Снова, для начала наблюдаемость, например:
* мониторинг нагрузки API
* мониторинг состояния заказов с разбивкой по статусам

Затем, для B2B пользователей могут помочь такие инициативы:
* масштабирование API для балансировки нагрузки
* ограничение кол-ва запросов в API (rate-limiting) или настройка Backpressure
* правильное документирование API, которое даст пользователям правильное понимание системы
* добавление кэширования для читающих запросов API (например, для ручек получения статуса заказов)
* разделение инстансов API под внешних/внутренних пользователей

### Интерфейс для операторов "тормозит"

Начинаем с наблюдаемости - в первую очередь трейсинг и мониторинги:
* состояние `MES API` (кол-во запросов, кол-во ошибок, время ответа)
* состояние фронтенда `MES` (health-чеки и прочее)
* состояние базы `MES db`

А для устранения проблем можно делать следующее:
* масштабирование `MES API`
* кэширование читающих запросов в API
* шардирование базы, если проблема в ней
* выделение отдельного сервиса для асинхронного расчета стоимости заказа,
  если от этого поступает значительная нагрузка

### Отказоустойчивость

Тут в целом и так понятно, что скорее всего у сервисов бывают даунтаймы (как минимум, есть релизы),
но вот насколько долгие и частые - хорошо бы проверить мониторингами.

В любом случае, скорее всего надо будет повышать отказоустойчивость сервисов:
* добавлять реплики для API-сервисов. Будет не так сложно, потому что прямого
  взаимодействия между сервисами нет, нужны будут только `BFF`/`ApiGW`
* добавлять реплики для БД, чтобы не терять данные

### Задержки релизов

В этом случае мониторинги не особо помогут, скорее просто статистика по последним релизам.

Инициативы могут быть такие:
* нанять в команду больше QA-инженеров (хотя бы еще одного), но это займет время
* начать постепенную автоматизацию E2E-тестирования, тем более что QA-инженер
  в команде уже пробовал этим заниматься. Это поможет в перспективе разгрузить
  QA-инженеров и уменьшить зависимость релизов от них.

### Возможная несогласованность статуса заказов

Обнаружить такие ситуации, если они уже происходят, будет довольно тяжело.
Для облегчения разбора несогласованностей, нужно добавлять логирование и по-хорошему трейсинг.

А еще, может помочь что-то из этого:
* нормализация баз данных (хотя бы статусы заказов можно оставить в одном месте)
* выделение отдельного сервиса, который будет мастер-системой статуса заказов

