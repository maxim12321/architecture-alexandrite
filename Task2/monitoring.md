# Выбор и настройка мониторинга в системе

## Мотивация

Клиенты жалуются менеджерам по продажам, что они не получили заказ и над их
изделием работают уже несколько месяцев, хотя обещали закончить за три недели.

Более того, компания постоянно теряет B2B клиентов, которые также не получают
свои заказы.

Производственные мощности хоть и позволяют справляться с бОльшим количеством
заказов, но операторы тоже жалуются на медленную работу системы.

Все эти проблемы необходимо решать как можно быстрее, чтобы перестать терять
клиентов, но это слишком сложно ввиду отсутствия мониторингов.

Мониторинги позволят находить проблемы в системе раньше, чем на них начнут
жаловаться клиенты компании, а своевременно их устранять. Мониторинг повысит
быстродействие системы, поможет выявить узкие места и оптимизировать
производительность.

Также наличие общей статистики по нагрузке системы и прочим важным данным
поможет в дальнейшем принимать более взвешенные архитектурные решения.

## Выбор подхода к мониторингу

Из основных подходов, USE подходит плохо, т.к. ему тяжело жить при наличии
кэширования в системе. Его у нас, конечно, на данный момент нет, но это
первый шаг в списке инициатив.

Также очень хочется так или иначе отслеживать "насыщенность" системы,
потому что после открытия API для внешних пользователей проблема
производительности стала особенно актуальной. Скорее всего, `MES API` сейчас
перегружено, но желательно убедиться в этом через мониторинг.

Таким образом, предлагаю использовать **"четыре золотых сигнала"**:
* **трафик** и **насыщенность** помогут понять, что система перегружена и
нуждается в масштабировании. Также это поможет проверить эффективность
кэширования, которое планируется добавить в скором времени
* **ошибки** в целом покажут, насколько часто возникают некорректные ситуации
или таймауты в системе

## Метрики

В первую очередь имеет смысл собирать следующие метрики:

* **(1) Number of dead-letter-exchange letters in RabbitMQ** - позволит прежде
всего понять, хватает ли `MES API` для обработки заказов
* **(3,4,5) RPS for APIs** - соответствует **трафику** в четырех золотых
сигналах, на будущее также нужен ярлык с адресом конкретного хоста и URL для
мониторинга конкретных ручек
* **(8) RPS per user for MES API** - т.к. это `API` предоставляется в том числе
крупным B2B-клиентам, можно отслеживать, какие из них больше всего пользуются
системой и, возможно, достойны отдельного инстанса. Тут нужны ярлыки с `id`
пользователя, адресом хоста и полным URL
* **(11,14) CPU and Memory utilisation for MES API** - кажется, что это самое
нагруженное API, поэтому хочется проверять его **насыщенность**, снова на будущее
добавим ярлык для разделения метрик с разных хостов API
* **(21) Response time (latency) for MES API** - для фиксирования
**задержки**/**трафика** в системе, с адресом хоста и URL-ом в ярлыке
* **(22) Size of S3 storage** - размер хранилища напрямую влияет на стоимость
его использования для компании, поэтому важно мониторить его размер, возможно
даже настроить автоматическую очистку устаревших данных
* **(28-31) Number of HTTP 500 for APIs** - для всех апишек будет полезно считать
количество 500-к, это отражает **ошибки** в четырех золотых сигналах, понадобятся
ярлыки на конретные хосты, а также на URL-суффиксы для отслеживания проблемных
ручек
* **(35,38) Kb received/sent for shop API** - покажет, насколько загрузка
пользовательских файлов нагружает систему; также может быть показателем
вредоносной нагрузки на API (DDoS-атаки и прочее)

## План действий

Верхнеуровневый план действий будет выглядеть так:
1. Поднять инстанс БД временных рядов `Prometheus`, который будет собирать и
хранить метрики
2. Добавить exporter'ы в API для выгрузки метрик
3. Добавить инстанс `Grafana` для визуализации метрик и создания дашбордов
4. Настроить основные дашборды (как минимум, "четырех золотых сигналов")
5. Настроить необходимые алерты в графане
6. Добавить `RabbitMQ exporter` для сбора метрик с очереди событий
7. Добавить `PostgreSQL exporter`'ы на базы данных
8. Настроить визуализацию метрик `S3`-хранилища в графане (если возможно)
